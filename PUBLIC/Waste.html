<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Waste Generation Survey</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Public+Sans%3Awght%40400%3B500%3B700%3B900" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .dropdown-menu { display: none; }
        #user-avatar-container:hover .dropdown-menu { display: block; }
    </style>
</head>
<body>
<div class="relative flex min-h-screen w-full flex-col bg-white" style="font-family: &quot;Public Sans&quot;, &quot;Noto Sans&quot;, sans-serif;">
<div class="flex h-full grow flex-col">
    <header class="flex items-center justify-between whitespace-nowrap border-b border-b-[#e7f3e7] px-10 py-3">
        <div class="flex items-center gap-4 text-[#0e1b0e]">
            <a href="/home.html" class="flex items-center gap-4">
                <div class="size-8 text-[#17cf17]">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-[#0e1b0e] text-lg font-bold">EcoLife</h2>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <button id="login-button" class="hidden min-w-[84px] cursor-pointer items-center justify-center rounded-md h-10 px-4 bg-green-500 text-white text-sm font-bold hover:bg-green-600">
                <span>Login</span>
            </button>
            <div id="user-avatar-container" class="hidden relative">
                <img id="user-avatar-img" src="" alt="User Avatar" class="aspect-square bg-cover rounded-full size-10 cursor-pointer"/>
                <div class="dropdown-menu absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                    <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                    <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex flex-1 justify-center py-10 bg-gray-50/50">
        <div class="w-full max-w-2xl">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200/80 p-8">
                <div class="flex gap-4 justify-between items-center">
                    <p class="text-slate-600 text-sm font-medium">Step 1 of 4</p>
                    <div class="flex items-center gap-2">
                        <div class="h-1.5 w-10 rounded-full bg-[#17cf17]"></div>
                        <div class="h-1.5 w-10 rounded-full bg-gray-200"></div>
                        <div class="h-1.5 w-10 rounded-full bg-gray-200"></div>
                        <div class="h-1.5 w-10 rounded-full bg-gray-200"></div>
                    </div>
                </div>
                <div class="text-center py-6">
                    <h1 class="text-slate-900 text-3xl font-bold tracking-tight">Waste Generation Survey</h1>
                    <p class="text-slate-600 text-base mt-2">Help us understand your waste habits to provide personalized solutions for a greener lifestyle.</p>
                </div>
                <form id="waste-survey-form" class="flex flex-col gap-6 mt-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-slate-800 text-sm font-medium" for="household-size">Household Size</label>
                        <select required class="form-select flex w-full h-12 px-3 rounded-md text-slate-700 border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-[#17cf17]" id="household-size">
                            <option value="">Select number of people</option>
                            <option value="1">1 person</option>
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5+ people</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-slate-800 text-sm font-medium" for="collection-frequency">Waste Collection Frequency</label>
                        <select required class="form-select flex w-full h-12 px-3 rounded-md text-slate-700 border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-[#17cf17]" id="collection-frequency">
                            <option value="">Select frequency</option>
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-weekly">Bi-weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-slate-800 text-sm font-medium" for="recycling-practices">Recycling Practices</label>
                        <select required class="form-select flex w-full h-12 px-3 rounded-md text-slate-700 border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-[#17cf17]" id="recycling-practices">
                            <option value="">Select your recycling habits</option>
                            <option value="Always">I always recycle</option>
                            <option value="Sometimes">I sometimes recycle</option>
                            <option value="Rarely">I rarely recycle</option>
                            <option value="Never">I never recycle</option>
                        </select>
                    </div>
                    <div class="flex pt-6 justify-end">
                        <button type="submit" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center rounded-md h-12 px-6 bg-[#17cf17] text-white text-base font-bold hover:bg-green-600 transition-colors">
                            <span class="truncate">Submit Survey</span>
                            <span class="material-symbols-outlined ml-2">arrow_forward</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // --- 1. Authentication & UI Update ---
        const loginButton = document.getElementById('login-button');
        const userAvatarContainer = document.getElementById('user-avatar-container');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const logoutButton = document.getElementById('logout-button');

        const checkAuthStatus = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/current-user`, {
                    credentials: 'include',
                });

                if (response.ok) {
                    const user = await response.json();
                    loginButton.classList.add('hidden');
                    userAvatarContainer.classList.remove('hidden');
                    userAvatarImg.src = user.avatarUrl || 'https://via.placeholder.com/150';
                    return true;
                } else {
                    // This is a protected page, redirect if not logged in
                    window.location.href = '/home.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/home.html';
                return false;
            }
        };

        const handleLogout = async () => {
            await fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = '/home.html';
        };

        logoutButton.addEventListener('click', handleLogout);
        
        // --- 2. Protect Page and Handle Form ---
        const isLoggedIn = await checkAuthStatus();
        if (!isLoggedIn) return; // Stop executing script if not logged in

        const surveyForm = document.getElementById('waste-survey-form');
        surveyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const surveyData = {
                householdSize: document.getElementById('household-size').value,
                wasteCollectionFrequency: document.getElementById('collection-frequency').value,
                recyclingPractices: document.getElementById('recycling-practices').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/users/survey`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(surveyData),
                    credentials: 'include' // Important for sending auth cookie
                });

                if (response.ok) {
                    alert('Thank you! Your survey has been submitted.');
                    // You could redirect to the leaderboard or another page
                    window.location.href = '/leaderboard.html';
                } else {
                    const errorData = await response.json();
                    alert(`Submission Failed: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Survey submission error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });
</script>
</body>
</html>