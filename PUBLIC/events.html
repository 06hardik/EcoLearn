<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>ECO EVENTS</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Public+Sans:wght@400;500;600;700;800" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .dropdown-menu { display: none; }
        #user-avatar-container:hover .dropdown-menu { display: block; }
    </style>
</head>
<body class="bg-[#F7F9F7]">
<div class="relative flex min-h-screen w-full flex-col bg-[#F7F9F7]" style='font-family: "Public Sans", "Noto Sans", sans-serif;'>
    <header class="flex items-center justify-between whitespace-nowrap border-b border-b-[#E0E0E0] px-10 py-4">
        <div class="flex items-center gap-3 text-[#0B120B]">
             <a href="/home.html" class="flex items-center gap-3">
                <div class="size-6 text-[#17CF17]">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z" fill="currentColor"></path></svg>
                </div>
                <h2 class="text-[#0B120B] text-xl font-bold">EcoAction</h2>
            </a>
        </div>
        <nav class="hidden lg:flex items-center gap-6">
            <a class="text-[#0B120B] text-base font-medium hover:text-[#17CF17]" href="/home.html">Home</a>
            <a class="text-[#0B120B] text-base font-medium hover:text-[#17CF17]" href="#">About</a>
            <a class="text-[#0B120B] text-base font-medium hover:text-[#17CF17]" href="#">Programs</a>
        </nav>
        <div class="flex flex-1 justify-end items-center gap-4">
            <button id="login-button" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-md h-10 px-4 bg-green-500 text-white text-sm font-bold hover:bg-green-600">
                <span>Login</span>
            </button>
            <div id="user-avatar-container" class="hidden relative">
                <img id="user-avatar-img" src="" alt="User Avatar" class="aspect-square bg-cover rounded-full size-10 cursor-pointer"/>
                <div class="dropdown-menu absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                    <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                    <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 sm:px-10 lg:px-20 xl:px-40 py-10 flex flex-1 justify-center">
        <div class="flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-col gap-4 text-center mb-8">
                <h1 class="text-[#0B120B] text-4xl font-bold">Upcoming Events</h1>
                <p class="text-[#4A644A] text-lg">Find local events and campaigns to get involved in environmental action.</p>
            </div>
            
            <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p>Loading events...</p>
            </div>

            <section class="mt-20">
                <h2 class="text-[#0B120B] text-3xl font-bold text-center">Share Your Impact</h2>
                <div class="mt-8 flex flex-col items-center gap-6 rounded-lg border-2 border-dashed border-[#A8D3A8] px-6 py-14 bg-white">
                    <span class="material-symbols-outlined text-5xl text-[#17CF17]">cloud_upload</span>
                    <p class="text-[#0B120B] text-xl font-bold">Upload Photos</p>
                    <p class="text-[#4A644A] text-base text-center">Share your photos from events and campaigns to inspire others.</p>
                    <button class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-md h-12 px-6 bg-[#17cf17] text-[#0B120B] text-base font-bold hover:bg-opacity-90">
                        <span>Browse Files</span>
                    </button>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://localhost:8000/api';
        let currentUser = null;

        // --- 1. Authentication & UI Update ---
        const loginButton = document.getElementById('login-button');
        const userAvatarContainer = document.getElementById('user-avatar-container');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const logoutButton = document.getElementById('logout-button');

        const checkAuthStatus = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/current-user`, { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                    loginButton.classList.add('hidden');
                    userAvatarContainer.classList.remove('hidden');
                    userAvatarImg.src = currentUser.avatarUrl || 'https://via.placeholder.com/150';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        };

        const handleLogout = async () => {
            await fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = '/home.html';
        };
        
        logoutButton.addEventListener('click', handleLogout);
        checkAuthStatus();

        // --- 2. Fetch and Render Events ---
        const eventsContainer = document.getElementById('events-container');

        const fetchEvents = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/events`);
                if (!response.ok) throw new Error('Failed to fetch events');
                const events = await response.json();
                
                eventsContainer.innerHTML = ''; // Clear loading text

                events.forEach(event => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'flex flex-col rounded-lg bg-white border border-[#E0E0E0] shadow-sm overflow-hidden transform hover:-translate-y-1 transition-transform duration-300';
                    
                    const eventDate = new Date(event.date);
                    const formattedDate = eventDate.toLocaleDateString('en-US', {
                        month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
                    });

                    eventCard.innerHTML = `
                        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: url('${event.imageUrl}');"></div>
                        <div class="p-5 flex flex-col flex-1">
                            <p class="text-[#4A644A] text-sm font-medium">${formattedDate} | ${event.location}</p>
                            <h3 class="text-[#0B120B] text-lg font-bold mt-1">${event.title}</h3>
                            <p class="text-[#4A644A] text-base mt-2 flex-1">${event.description}</p>
                            <button data-event-id="${event._id}" class="register-button flex mt-4 min-w-[84px] items-center justify-center rounded-md h-10 px-4 bg-[#17CF17] text-[#0B120B] text-base font-bold hover:bg-opacity-90">
                                <span class="truncate">${event.eventType === 'Workshop' ? 'Register' : 'Volunteer'}</span>
                            </button>
                        </div>
                    `;
                    eventsContainer.appendChild(eventCard);
                });

            } catch (error) {
                console.error(error);
                eventsContainer.innerHTML = '<p>Could not load events at this time.</p>';
            }
        };

        // --- 3. Handle Event Registration Clicks ---
        eventsContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('.register-button');
            if (!button) return;

            if (!currentUser) {
                alert('Please log in to register for an event.');
                // Optional: Open the login modal if you have it on this page
                return;
            }

            const eventId = button.dataset.eventId;
            button.textContent = 'Registering...';
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/events/${eventId}/register`, {
                    method: 'POST',
                    credentials: 'include' // Send auth cookie
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    button.textContent = 'Registered!';
                    button.classList.replace('bg-[#17CF17]', 'bg-gray-400');
                } else {
                    alert(`Error: ${result.message}`);
                    button.textContent = 'Register';
                    button.disabled = false;
                }
            } catch (error) {
                console.error('Registration failed:', error);
                alert('Registration failed. Please try again.');
                button.textContent = 'Register';
                button.disabled = false;
            }
        });

        fetchEvents();
    });
</script>
</body>
</html>