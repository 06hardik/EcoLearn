<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>ECO Home</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Public+Sans:wght@400;500;700;900" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        .dropdown-menu { display: none; }
        #user-avatar-container:hover .dropdown-menu { display: block; }
    </style>
</head>
<body>
<div class="relative flex min-h-screen w-full flex-col bg-slate-50" style='font-family: "Public Sans", "Noto Sans", sans-serif;'>
<div class="flex h-full grow flex-col">
    <header class="flex items-center justify-between whitespace-nowrap border-b border-b-gray-200 px-10 py-3">
        <div class="flex items-center gap-3 text-gray-800">
            <span class="material-symbols-outlined text-3xl text-green-600">eco</span>
            <h2 class="text-gray-800 text-xl font-bold">EcoLearn</h2>
        </div>
        <nav class="hidden lg:flex items-center gap-8">
            <a class="text-gray-600 hover:text-green-600 text-sm font-medium" href="./learning.html">Learn</a>
            <a class="text-gray-600 hover:text-green-600 text-sm font-medium" href="./events.html">Campaigns</a>
            <a class="text-gray-600 hover:text-green-600 text-sm font-medium" href="#">Green Points</a>
            <a class="text-gray-600 hover:text-green-600 text-sm font-medium" href="./ecommerce.html">Shop</a>
        </nav>
        <div class="flex items-center gap-2">
            <button id="login-button" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-md h-10 px-4 bg-green-500 text-white text-sm font-bold hover:bg-green-600">
                <span>Login</span>
            </button>
            <div id="user-avatar-container" class="hidden relative">
                <img id="user-avatar-img" src="" alt="User Avatar" class="aspect-square bg-cover rounded-full size-10 cursor-pointer"/>
                <div class="dropdown-menu absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                    <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                    <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 sm:px-12 lg:px-24 flex flex-1 justify-center py-10">
        <div class="flex flex-col max-w-7xl flex-1">
            <div class="p-2">
                <div class="flex min-h-[480px] flex-col gap-6 bg-cover bg-center rounded-2xl items-center justify-center p-4 text-center" style='background-image: linear-gradient(rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.5) 100%), url("https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop");'>
                    <h1 class="text-white text-4xl md:text-6xl font-bold">Empowering Communities for a Sustainable Future</h1>
                    <h2 class="text-gray-200 text-base md:text-lg max-w-3xl">Join us in our mission to educate, engage, and promote sustainable practices for a healthier planet.</h2>
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center rounded-full h-12 px-6 bg-green-500 text-white text-base font-bold shadow-md hover:bg-green-600">
                        <span>Explore Our Initiatives</span>
                    </button>
                </div>
            </div>

            <h2 class="text-gray-800 text-3xl font-bold px-4 pb-4 pt-12">Featured Campaigns</h2>
            <div id="campaigns-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 p-4">
                <p>Loading campaigns...</p>
            </div>

            </div>
    </main>

    <footer class="bg-gray-100 border-t border-gray-200">
        </footer>
</div>

<div id="modal-backdrop" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0"></div>

<div id="login-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="relative bg-slate-50 rounded-xl shadow-lg w-full max-w-md p-8">
        <button class="close-modal-button absolute top-4 right-4 text-gray-400 hover:text-gray-800">
            <span class="material-symbols-outlined">close</span>
        </button>
        <div class="text-center mb-6">
            <span class="material-symbols-outlined text-5xl text-green-600">eco</span>
            <h2 class="text-2xl font-bold text-gray-800 mt-2">Welcome Back!</h2>
        </div>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-bold text-white bg-green-500 hover:bg-green-600">Login</button>
        </form>
        <p class="mt-6 text-center text-sm text-gray-500">
            Don't have an account? <a href="#" class="show-signup-modal font-medium text-green-600 hover:text-green-500">Sign up</a>
        </p>
    </div>
</div>

<div id="signup-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="relative bg-slate-50 rounded-xl shadow-lg w-full max-w-md p-8">
        <button class="close-modal-button absolute top-4 right-4 text-gray-400 hover:text-gray-800">
            <span class="material-symbols-outlined">close</span>
        </button>
        <div class="text-center mb-6">
            <span class="material-symbols-outlined text-5xl text-green-600">eco</span>
            <h2 class="text-2xl font-bold text-gray-800 mt-2">Join EcoLearn Today</h2>
        </div>
        <form id="signup-form" class="space-y-4">
            <div>
                <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="signup-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-bold text-white bg-green-500 hover:bg-green-600">Create Account</button>
        </form>
        <p class="mt-6 text-center text-sm text-gray-500">
            Already have an account? <a href="#" class="show-login-modal font-medium text-green-600 hover:text-green-500">Log in</a>
        </p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://localhost:8000/api';

        // --- Authentication & UI Update ---
        const loginButton = document.getElementById('login-button');
        const userAvatarContainer = document.getElementById('user-avatar-container');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const logoutButton = document.getElementById('logout-button');

        const checkAuthStatus = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/current-user`, {
                    credentials: 'include', // Important for sending cookies
                });

                if (response.ok) {
                    const user = await response.json();
                    loginButton.classList.add('hidden');
                    userAvatarContainer.classList.remove('hidden');
                    userAvatarImg.src = user.avatarUrl || 'https://via.placeholder.com/150'; // Default avatar
                } else {
                    loginButton.classList.remove('hidden');
                    userAvatarContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                loginButton.classList.remove('hidden');
                userAvatarContainer.classList.add('hidden');
            }
        };

        const handleLogout = async () => {
            try {
                await fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' });
                window.location.reload(); // Reload the page to reflect logout state
            } catch (error) {
                console.error('Logout failed:', error);
            }
        };
        
        logoutButton.addEventListener('click', handleLogout);
        checkAuthStatus(); // Check auth status on every page load

        // --- Dynamic Content Loading ---
        const fetchFeaturedCampaigns = async () => {
            const campaignsContainer = document.getElementById('campaigns-container');
            if (!campaignsContainer) return;

            try {
                const response = await fetch(`${API_BASE_URL}/events`);
                if (!response.ok) throw new Error('Failed to fetch');
                const campaigns = await response.json();
                
                campaignsContainer.innerHTML = ''; // Clear loading text

                campaigns.slice(0, 3).forEach(campaign => {
                    const campaignCard = document.createElement('div');
                    campaignCard.className = 'flex flex-col gap-4';
                    campaignCard.innerHTML = `
                        <div class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-xl" style="background-image: url('${campaign.imageUrl}');"></div>
                        <div>
                            <p class="text-gray-800 text-lg font-semibold">${campaign.title}</p>
                            <p class="text-gray-500 text-sm">${campaign.description}</p>
                        </div>
                    `;
                    campaignsContainer.appendChild(campaignCard);
                });
            } catch (error) {
                console.error('Failed to load campaigns:', error);
                campaignsContainer.innerHTML = '<p>Could not load campaigns.</p>';
            }
        };

        fetchFeaturedCampaigns();

        // --- Modal Handling ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal-button');
        const showSignupLinks = document.querySelectorAll('.show-signup-modal');
        const showLoginLinks = document.querySelectorAll('.show-login-modal');

        const openModal = (modal) => {
            modalBackdrop.classList.remove('hidden');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modal.classList.remove('opacity-0');
            }, 10);
        };

        const closeModal = () => {
            modalBackdrop.classList.add('opacity-0');
            loginModal.classList.add('opacity-0');
            signupModal.classList.add('opacity-0');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                loginModal.classList.add('hidden');
                signupModal.classList.add('hidden');
            }, 250);
        };
        
        loginButton.addEventListener('click', () => openModal(loginModal));
        modalBackdrop.addEventListener('click', closeModal);
        closeModalButtons.forEach(btn => btn.addEventListener('click', closeModal));

        showSignupLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal();
            setTimeout(() => openModal(signupModal), 260);
        }));

        showLoginLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal();
            setTimeout(() => openModal(loginModal), 260);
        }));
        
        // --- Form Submission ---
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.reload(); // Reload to update UI
                } else {
                    const errorData = await response.json();
                    alert(`Login Failed: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login.');
            }
        });

        const signupForm = document.getElementById('signup-form');
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                if (response.ok) {
                    alert('Registration successful! Please log in.');
                    closeModal();
                    setTimeout(() => openModal(loginModal), 260);
                } else {
                    const errorData = await response.json();
                    alert(`Registration Failed: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('An error occurred during registration.');
            }
        });
    });
</script>
</body>
</html>