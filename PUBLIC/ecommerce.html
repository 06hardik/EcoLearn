<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>E-commerce</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Public+Sans:wght@400;500;700;900" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .dropdown-menu { display: none; }
        #user-avatar-container:hover .dropdown-menu { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900" style='font-family: "Public Sans", "Noto Sans", sans-serif;'>
<div class="relative flex min-h-screen w-full flex-col">
    <header class="sticky top-0 z-20 w-full bg-white/80 backdrop-blur-lg border-b border-gray-200">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center gap-4">
                <a class="flex items-center gap-2 text-primary-700" href="/home.html">
                    <span class="material-symbols-outlined text-3xl text-green-600">eco</span>
                    <h2 class="text-xl font-bold tracking-tight text-gray-800">EcoLife</h2>
                </a>
            </div>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-medium text-gray-600 hover:text-green-600" href="/home.html">Home</a>
                <a class="text-sm font-medium text-gray-600 hover:text-green-600" href="#">About</a>
                <a class="text-sm font-bold text-green-600" href="/ecommerce.html">Shop</a>
                <a class="text-sm font-medium text-gray-600 hover:text-green-600" href="#">Contact</a>
            </nav>
            <div class="flex items-center gap-4">
                 <button class="relative flex items-center justify-center rounded-full h-10 w-10 text-gray-500 hover:bg-gray-100">
                    <span class="material-symbols-outlined">shopping_bag</span>
                    <span id="cart-count" class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-green-600 text-xs font-bold text-white">0</span>
                </button>
                <button id="login-button" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-md h-10 px-4 bg-gray-100 text-gray-800 text-sm font-bold hover:bg-gray-200">
                    <span>Login</span>
                </button>
                 <div id="user-avatar-container" class="hidden relative">
                    <img id="user-avatar-img" src="" alt="User Avatar" class="aspect-square bg-cover rounded-full size-10 cursor-pointer"/>
                    <div class="dropdown-menu absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                        <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                        <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex flex-col lg:flex-row gap-12">
                <div class="w-full lg:w-3/4">
                    <h1 class="text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl">Eco-Friendly Shop</h1>
                    <p class="mt-4 text-lg text-gray-600">Discover our curated collection of sustainable products.</p>
                    <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 mt-8">
                        <p>Loading products...</p>
                    </div>
                </div>
                <div class="w-full lg:w-1/4">
                    <div class="sticky top-28 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Order Summary</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between text-gray-600">
                                <span>Subtotal</span>
                                <span id="summary-subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>Shipping</span>
                                <span id="summary-shipping">$0.00</span>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex justify-between font-semibold text-gray-900">
                                    <span>Total</span>
                                    <span id="summary-total">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div id="points-section" class="mt-8 hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Use Green Points</h3>
                            <p class="text-sm text-gray-500 mb-4">You have <span id="user-points" class="font-bold text-green-600">0</span> Green Points available.</p>
                            <div class="flex">
                                <input id="points-input" class="form-input w-full rounded-l-md border-gray-300 focus:border-green-500 focus:ring-green-500" placeholder="Enter points" type="number"/>
                                <button id="apply-points-button" class="bg-green-600 text-white px-4 py-2 rounded-r-md hover:bg-green-700 text-sm font-semibold">Apply</button>
                            </div>
                        </div>
                        <div id="discount-row" class="mt-4 hidden justify-between text-sm text-green-700">
                            <span>Green Points Discount</span>
                            <span id="summary-discount">-$0.00</span>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <div class="flex justify-between font-bold text-xl text-gray-900">
                                <span>Grand Total</span>
                                <span id="summary-grand-total">$0.00</span>
                            </div>
                        </div>
                        <button id="checkout-button" class="w-full mt-8 bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-gray-400">
                            <span class="material-symbols-outlined">lock</span>
                            Proceed to Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://localhost:8000/api';
        let currentUser = null;
        let cart = [];
        let pointsToUse = 0;
        const SHIPPING_COST = 5.00;

        // --- 1. Authentication & UI ---
        const loginButton = document.getElementById('login-button');
        const userAvatarContainer = document.getElementById('user-avatar-container');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const logoutButton = document.getElementById('logout-button');
        const pointsSection = document.getElementById('points-section');
        const userPointsSpan = document.getElementById('user-points');

        const checkAuthStatus = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/current-user`, { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                    loginButton.classList.add('hidden');
                    userAvatarContainer.classList.remove('hidden');
                    userAvatarImg.src = currentUser.avatarUrl || 'https://via.placeholder.com/150';
                    pointsSection.classList.remove('hidden');
                    userPointsSpan.textContent = currentUser.points;
                }
            } catch (error) { console.error('Auth check failed:', error); }
        };
        
        const handleLogout = async () => {
            await fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' });
            window.location.reload();
        };

        logoutButton.addEventListener('click', handleLogout);
        checkAuthStatus();

        // --- 2. Product Loading ---
        const productsContainer = document.getElementById('products-container');
        const fetchProducts = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                const products = await response.json();
                productsContainer.innerHTML = ''; // Clear loading text
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'group flex flex-col overflow-hidden rounded-lg shadow-sm hover:shadow-lg bg-white';
                    productCard.innerHTML = `
                        <div class="relative">
                            <div class="w-full bg-center bg-no-repeat aspect-square bg-cover" style="background-image: url('${product.imageUrl}');"></div>
                            <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <button data-product-id="${product._id}" class="add-to-cart-button bg-green-600 text-white rounded-full px-4 py-2 text-sm font-semibold">Add to Cart</button>
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col">
                            <h3 class="text-base font-semibold text-gray-800">${product.name}</h3>
                            <p class="text-sm text-gray-500 mt-1">${product.description}</p>
                            <p class="text-lg font-bold text-green-700 mt-auto pt-2">$${product.price.toFixed(2)}</p>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });
            } catch (error) {
                productsContainer.innerHTML = '<p>Could not load products.</p>';
            }
        };

        fetchProducts();
        
        // --- 3. Cart Logic ---
        const cartCountSpan = document.getElementById('cart-count');
        const summarySubtotal = document.getElementById('summary-subtotal');
        const summaryShipping = document.getElementById('summary-shipping');
        const summaryTotal = document.getElementById('summary-total');
        const summaryDiscount = document.getElementById('summary-discount');
        const summaryGrandTotal = document.getElementById('summary-grand-total');
        const discountRow = document.getElementById('discount-row');

        const updateOrderSummary = () => {
            const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const shipping = subtotal > 0 ? SHIPPING_COST : 0;
            const total = subtotal + shipping;
            const discountAmount = pointsToUse * 0.10; // Assuming 1 point = $0.10
            const grandTotal = total - discountAmount;

            summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
            summaryShipping.textContent = `$${shipping.toFixed(2)}`;
            summaryTotal.textContent = `$${total.toFixed(2)}`;
            summaryGrandTotal.textContent = `$${grandTotal.toFixed(2)}`;
            cartCountSpan.textContent = cart.reduce((acc, item) => acc + item.quantity, 0);
            
            if (discountAmount > 0) {
                summaryDiscount.textContent = `-$${discountAmount.toFixed(2)}`;
                discountRow.classList.remove('hidden');
                discountRow.classList.add('flex');
            } else {
                discountRow.classList.add('hidden');
            }
        };

        productsContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('.add-to-cart-button');
            if (!button) return;

            const productId = button.dataset.productId;
            const existingItem = cart.find(item => item.product === productId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                const product = await response.json();
                cart.push({ product: product._id, name: product.name, quantity: 1, price: product.price });
            }
            updateOrderSummary();
        });

        // --- 4. Points & Checkout ---
        const applyPointsButton = document.getElementById('apply-points-button');
        const pointsInput = document.getElementById('points-input');
        const checkoutButton = document.getElementById('checkout-button');

        applyPointsButton.addEventListener('click', () => {
            const points = parseInt(pointsInput.value, 10);
            if (isNaN(points) || points < 0) {
                pointsToUse = 0;
            } else if (points > currentUser.points) {
                alert('You cannot use more points than you have.');
                pointsToUse = 0;
                pointsInput.value = 0;
            } else {
                pointsToUse = points;
            }
            updateOrderSummary();
        });

        checkoutButton.addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please log in to proceed to payment.');
                return;
            }
            if (cart.length === 0) {
                alert('Your cart is empty.');
                return;
            }

            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Processing...';

            try {
                const orderData = {
                    items: cart.map(item => ({ product: item.product, quantity: item.quantity })),
                    pointsUsed: pointsToUse
                };
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    credentials: 'include'
                });
                if (response.ok) {
                    alert('Order placed successfully!');
                    cart = [];
                    pointsToUse = 0;
                    updateOrderSummary();
                    window.location.reload(); // Or redirect to an order confirmation page
                } else {
                    const error = await response.json();
                    alert(`Order failed: ${error.message}`);
                }
            } catch (error) {
                alert('An error occurred during checkout.');
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.innerHTML = `<span class="material-symbols-outlined">lock</span> Proceed to Payment`;
            }
        });
    });
</script>
</body>
</html>